---
title: "Practical Malware Analysis - Lab 11 write-up"
tags:
  - Practical Malware Analysis
---
![](/assets/images/practical_malware_analysis.png)<br>
Chapter 11 - "Malware Behavior" is the first chapter of part 4 in the Practical Malware Analysis book. Part 4 is all about malware functionality. Chapter 11 discusses malware types such as backdoors and credential stealers, persistence mechanisms like DLL hijacking, privilege escalation using SeDebugPrivilege, and user-mode rootkit techniques. 

## Lab 11-1
*Analyze the malware found in Lab11-01.exe.* 

**1. What does the malware drop to disk?** <br>
**Answer:** Procmon results show that the malware drops a file named <code>msgina32.dll</code> in the current directory.
![](/assets/images/Pasted image 20221021130216.png)<br>
During basic static analysis on the <code>Lab11-01.exe</code> file, I noticed that there's another executable in the .rsrc section of the program:
![](/assets/images/Pasted image 20221021111825.png)<br>
Exporting this resource and comparing the file hash to the <code>msgina32.dll</code> file shows us that this is the same file.

**2. How does the malware achieve persistence?** <br>
**Answer:** The program creates a new registry key named <code>HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\GinaDLL</code> with a value that points to the location of the malicious <code>msgina32.dll</code> file.
![](/assets/images/Pasted image 20221021131748.png)<br>

**3. How does the malware steal user credentials?**<br>
**Answer:** This malware uses GINA interception to steal user credentials. GINA interception is a credential stealing technique on Windows XP. The GINA system was intended to allow legitimate third parties to customize the logon process by adding support for things like authentication with RFID tokens. 
Windows provides the <code>HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\GinaDLL</code> registry key location where third-party DLLs will be found and loaded by Winlogon. In my previous answer we already saw that the location to the malicious <code>msgina32.dll</code> file is placed here.
The book mentions that in order to intercept communication between Winlogon and the legitimate <code>msgina.dll</code>, the malware must contain all DLL exports required by GINA. It must export more than 15 functions, most of which are prepended with **Wlx**. If you are analysing a DLL with many export functions that begin with the string **Wlx**, you have a good indicator that you are examining a GINA interceptor. That is exactly what we see when we look at the export table of the malicious <code>msgina32.dll</code> file.
![](/assets/images/Pasted image 20221021111953.png)<br>

**4. What does the malware do with stolen credentials?** <br>
**Answer:** The stolen credentials are stored in a file called <code>msutil32.sys</code>, which can be found in <code>C:\WINDOWS\system32</code>.

The **WlxLoggedOutSAS** export function of the malicious <code>msgina32.dll</code> file contains the following instructions:
![](/assets/images/Pasted image 20221021141218.png)<br>
It takes parameters of the credential information and a format string to print credentials (that looks a lot similar to the example described in the book) before calling the <code>sub_10001570</code> function.
The <code>sub_10001570</code> function contains the name of the file that the credentials will be written to:
![](/assets/images/Pasted image 20221021113347.png)<br>
![](/assets/images/Pasted image 20221021140900.png)<br>

**5. How can you use this malware to get user credentials from your test environment?**<br>
**Answer:** You can open the <code>msutil32.sys</code> file in notepad to view the credentials after rebooting and logging in:
![](/assets/images/Pasted image 20221021140730.png)<br>

### Comparing my answers to the Lab 11-1 solutions
Conclusions after comparison:
- No differences! w00t!

## Lab 11-2
Analyze the malware found in Lab11-02.dll. Assume that a suspicious file named Lab11-02.ini was also found with this malware. 

**1. What are the exports for this DLL malware?** <br>
**Answer:** <code>installer</code> and <code>DllEntryPoint</code>.
![](/assets/images/Pasted image 20221021112952.png)<br>

**2. What happens after you attempt to install this malware using rundll32.exe?** <br>
**Answer:** You can install the malware by supplying it with the <code>installer</code> export. The command to install the malware is: <code>rundll32 Lab11-02.dll, installer</code>.
Filtering on "rundll32.exe" in procmon shows that the installer adds <code>spoolvxx32.dll</code> to the <code>HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows\AppInit_DLLs</code> registry key:
![](/assets/images/Pasted image 20221102102508.png)<br>
The <code>spoolvxx32.dll</code> file is created in <code>C:\WINDOWS\system32</code>:
![](/assets/images/Pasted image 20221102102557.png)<br>

**3. Where must Lab11-02.ini reside in order for the malware to install properly?** <br>
**Answer:** The installer attempts to read the <code>Lab11-02.ini</code> file from the <code>C:\WINDOWS\system32</code> directory. This is where the file should reside in order for the malware to install properly.
![](/assets/images/Pasted image 20221102102818.png)<br>

**4. How is this malware installed for persistence?** <br>
**Answer:** The malware uses the <code>HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows\AppInit_DLLs</code> registry key to achieve persistence. The <code>spoolvxx32.dll</code> file is added to the string of DLLs. <code>AppInit_DLLs</code> are loaded into every process that loads <code>User32.dll</code>. Most processes load <code>User32.dll</code>, and those processes will now also load the malicious <code>spoolvxx32.dll</code> file.
![](/assets/images/Pasted image 20221021113302.png)<br>

**5. What user-space rootkit technique does this malware employ?** <br>
**Answer:** This malware performs an inline hook on the <code>send</code> function of <code>wsock32.dll</code> if the e-mail clients <code>THEBAT.EXE</code>, <code>OUTLOOK.EXE</code>, or <code>MSIMN.EXE</code> are used:
![](/assets/images/Pasted image 20221103092849.png)<br>

**6. What does the hooking code do?** <br>
**Answer:** After playing around with Outlook Express and a fake mail server using INetSim, we can see that the hooking code adds another recipient to any e-mail sent by the victim:
![](/assets/images/Pasted image 20221103093657.png)<br>
The additional <code>billy@malwareanalysisbook.com</code> recipient cannot be seen when the victim views their sent items:
![](/assets/images/Pasted image 20221103093827.png)<br>

**7. Which process(es) does this malware attack and why?** <br>
**Answer:** <code>THEBAT.EXE</code>, <code>OUTLOOK.EXE</code>, and <code>MSIMN.EXE</code>. These are mail clients that the malware targets.<br>
![](/assets/images/Pasted image 20221021113608.png)<br>

**8. What is the significance of the .ini file?** <br>
**Answer:** I couldn't figure out what the significance of the .ini file is. It appears to be random encoded data:
![](/assets/images/Pasted image 20221103101208.png)<br>

**9. How can you dynamically capture this malwareâ€™s activity with Wireshark?**<br>
**Answer:** As already shown in answer 6, you can filter on SMTP traffic to capture the malware's activity.

### Comparing my answers to the Lab 11-2 solutions
Conclusions after comparison:
- The .ini file contains the encoded <code>billy@malwareanalysisbook.com</code> address that we discovered before. The function that is responsible for decoding this address is the first function called after opening a handle to the .ini file. We could've confirmed that this is a decoding function by loading the DLL in OllyDbg and placing a breakpoint at <code>0x100016CA</code>.

## Lab 11-3
Analyze the malware found in Lab11-03.exe and Lab11-03.dll. Make sure that both files are in the same directory during analysis.

**1. What interesting analysis leads can you discover using basic static analysis?** <br>
**Answer:** Using only basic static analysis, we can see that the <code>Lab11-03.exe</code> program copies the <code>Lab11-03.dll</code> file into <code>C:\WINDOWS\System32\inet_epar32.dll</code>. It also starts a service called <code>cisvc</code>.
![](/assets/images/Pasted image 20221021114241.png)<br>
Imports table of <code>Lab11-03.dll</code> shows that it may contain keylogger functionality:
![](/assets/images/Pasted image 20221021115138.png)<br>
<code>Lab11-03.dll</code> also seems to create a new DLL file called <code>C:\WINDOWS\System32\kernel64x.dll</code>:
![](/assets/images/Pasted image 20221021115329.png)<br>

**2. What happens when you run this malware?** <br>
**Answer:** We confirm that the malware creates <code>C:\WINDOWS\System32\inet_epar32.dll</code>, which we can see is a copy of <code>Lab11-03.dll</code> after checking the file hashes. 
![](/assets/images/Pasted image 20221103132851.png)<br>
The malware also launches <code>C:\WINDOWS\System32\cisvc.exe</code>, which is installed as a service named <code>Content Index Service</code>:
![](/assets/images/Pasted image 20221103131327.png)<br>
The <code>cisvc.exe</code> process has a file handle to <code>C:\WINDOWS\system32\kernel64x.dll</code>, which we also saw being referred to by the <code>Lab11-03.dll</code> file in our answer to question 1.
![](/assets/images/Pasted image 20221103131852.png)<br>
It looks like this file is used to store keylogs. If we open <code>kernel64x.dll</code> in notepad we see a bunch of entries related to windows that we opened, along with hexadecimal data (possibly keystrokes):
![](/assets/images/Pasted image 20221103132243.png)<br>

**3. How does Lab11-03.exe persistently install Lab11-03.dll?** <br>
**Answer:** <code>cisvc.exe</code> is modified so that it loads the malicious <code>inet_epar32.dll</code> file, which is a copy of <code>Lab11-03.dll</code>.
![](/assets/images/Pasted image 20221103135629.png)<br>

**4. Which Windows system file does the malware infect?** <br>
**Answer:** <code>cisvc.exe</code>

**5. What does Lab11-03.dll do?** <br>
**Answer:** <code>Lab11-03.dll</code> creates a mutex called <code>MZ</code>:
![](/assets/images/Pasted image 20221103140344.png)<br>
It then creates a file named <code>kernel64x.dll</code>:
![](/assets/images/Pasted image 20221103140441.png)<br>
After getting a file pointer to <code>kernel64x.dll</code>, the program stays in a loop with calls to <code>GetForegroundWindow</code>, <code>GetWindowTextA</code>, <code>GetAsyncKeyState</code>, and <code>WriteFile</code>. This means that <code>Lab11-03.dll</code> is most likely a **polling keylogger**. As discussed in the book, polling uses the Windows API to constantly poll the state of the keys, typically using the <code>GetAsyncKeyState</code> and <code>GetForegroundWindow</code> functions.

**6. Where does the malware store the data it collects?**<br>
**Answer:** The keylogs are stored in <code>kernel64x.dll</code>.


### Comparing my answers to the Lab 11-3 solutions
Conclusions after comparison:
- The malware persistently installs <code>Lab11-03.dll</code> by trojanizing the indexing service by **entry-point redirection**. It redirects the entry point of <code>cisvc.exe</code> to load <code>inet_epar32.dll</code> and call its export <code>zzz69806582</code>.

### Sources
- [Book: Practical Malware Analysis by Michael Sikorski and Andrew Honig](https://nostarch.com/malware)